\chapter{Finding shortest path vectors in SpiNNaker's network}
	
	\label{sec:shortestPaths}
	
	% XXX: Add note explaining shortest path between two points in non-torus
	% space.
	
	In the previous chapter we explored the practical challenges of building
	machines which use hexagonal torus topologies. In order to use such a machine
	we must be able to route packets through its network.  In this chapter we
	discuss the problem of finding shortest path vectors in hexagonal torus
	topologies. Shortest path vectors are used by many routing algorithms as the
	basis for the routes they generate. In non-hexagonal torus topologies,
	finding shortest path vectors is trivial and intuitive. In hexagonal toruses,
	this is not the case. In this chapter I introduce the \emph{Irregular
	Quadrant (IQ) method}, a new technique for computing shortest path vectors in
	hexagonal torus topologies.  The IQ method is cheaper to compute and more
	general than existing techniques, functioning correctly on hexagonal torus
	topologies of any aspect ratio. In non-square hexagonal torus topologies,
	many shortest path vectors may exist between some points. I propose a new
	technique for discovering all possible shortest path vectors which may allow
	routing algorithms to produce routes which more evenly load a network.
	
	In this chapter, I only consider idealised hexagonal torus topologies without
	faults or other irregularities. The challenge handling these artefacts of
	real world systems is tackled In chapter \ref{sec:routing}.
	
	\section{Shortest path vectors}
		
		Many popular routing algorithms for torus topologies, including all
		published algorithms designed for SpiNNaker \cite{davies12,navaridas14},
		function by computing \emph{shortest path vectors} between the endpoints of
		a route and generating routes from these. A shortest path vector between
		two nodes is a vector, $\mathbf{v} = (v_1, v_2, v_3, \ldots)$, whose
		magnitude, $\| \mathbf{v} \| = \lvert v_1 \rvert + \lvert v_2 \rvert +
		\lvert v_3 \rvert + \cdots$, is minimal with respect to all possible
		vectors between those nodes.
		
		In a non-hexagonal mesh topology, shortest path vectors are computed by
		taking the element-wise difference between the source and destination
		nodes' coordinates.
		
		\begin{figure}
			\center
			\buildfig{figures/mesh-topology-coordinates.tex}
			\caption{An example 2D mesh network with example shortest-path routes
			from `A' to `B' and `B' to `C'.}
			\label{fig:mesh-topology-coordinates}
		\end{figure}
		
		For example, figure \ref{fig:mesh-topology-coordinates} illustrates a 2D
		mesh topology. In this topology, the nodes labelled `A', `B' and `C' have
		position vectors $(1, 2)$, $(4, 5)$ and $(6, 1)$ respectively. The shortest
		path vector from node `A' to `B' is $(4, 5) - (1, 2) = (3, 3)$ and from `B'
		to `C' is $(6, 1) - (4, 5) = (2, -4)$. A route may be produced from a
		shortest path vector by advancing the number of hops specified for each
		dimension in the vector. For example a route from `A' to `B' may be
		constructed from any permutation of the hops
		X$^+\,$X$^+\,$X$^+\,$Y$^+\,$Y$^+\,$Y$^+$, an example of which is included
		in the figure. Likewise a route from `B' to `C' may be constructed from any
		permutation of the hops X$^+\,$X$^+\,$Y$^-\,$Y$^-\,$Y$^-\,$Y$^-$.
		
		Many popular routing algorithms such as Dimension Order Routing, Right-Turn
		Only Routing and Longest Dimension First Routing \cite{dally04,davies12}
		simply prescribe a rule for ordering the hops specified by a shortest path
		vector. Regardless of the permutation of hops, the length of the route
		produced from a shortest path vector, $\mathbf{v}$, is given by its
		magnitude, $\|\mathbf{v}\|$.
		
		\subsection{Torus Networks}
			
			\begin{figure}
				\center
				\begin{subfigure}{0.3\linewidth}
					\center
					\buildfig{figures/torus-shortest-path-example.tex}
					\caption{Original}
					\label{fig:torus-shortest-path-example}
				\end{subfigure}
				\begin{subfigure}{0.3\linewidth}
					\center
					\buildfig{figures/torus-shortest-path-translate.tex}
					\caption{Routed \& translated}
					\label{fig:torus-shortest-path-translate}
				\end{subfigure}
				\begin{subfigure}{0.3\linewidth}
					\center
					\buildfig{figures/torus-shortest-path-routed.tex}
					\caption{Routed original}
					\label{fig:torus-shortest-path-routed}
				\end{subfigure}
				
				\caption{Finding shortest paths in a 2D torus topology.}
				\label{fig:torus-shortest-path}
			\end{figure}
			
			Computing shortest path vectors in non-hexagonal torus topologies is also
			straight forward. For example, lets find the shortest path vector from
			node `A' to `B' in the 2D torus topology shown in figure
			\ref{fig:torus-shortest-path-example}. Both nodes are translated such
			that the source node, `A', is at the centre of the network and a shortest
			path vector computed as if in a mesh network (figure
			\ref{fig:torus-shortest-path-translate}). Note that, as in this example,
			translation may cause the destination node to `wrap around' the network.
			As illustrated in \ref{fig:torus-shortest-path-routed}, the computed
			shortest path vector is also valid for the two points prior to
			translation.
			
			\begin{figure}
				\center
				
				\begin{subfigure}{\linewidth}
					\center
					\buildfig{figures/distance-map-mesh.tex}
					\caption{2D mesh topology}
					\label{fig:distance-map-mesh}
				\end{subfigure}
				
				\vspace{1em}
				
				\begin{subfigure}{\linewidth}
					\center
					\buildfig{figures/distance-map-torus.tex}
					\caption{2D torus topology}
					\label{fig:distance-map-torus}
				\end{subfigure}
				
				\caption{Plots showing the magnitude of shortest path vectors in a 2D
				(non-hexagonal) topology from various locations marked
				{\color{red}$\times$}.  Darker areas are further away. Contour lines show
				equidistant points.}
				
				\label{fig:distance-map-mesh}
			\end{figure}
			
			This procedure works because vectors from the centre of a non-hexagonal
			torus topology to any other point are identical to those in a
			corresponding mesh topology. For example, in figures
			\ref{fig:distance-map-mesh} and \ref{fig:distance-map-torus} we can see
			that the magnitude of the shortest path vectors from the centre of a mesh
			and torus grow identically. Conversely, the magnitudes of vectors from
			other locations in mesh and torus topologies do not match.
			
			In a non-hexagonal mesh topology there is always exactly one vector
			between any pair of nodes. By definition this is also the shortest path
			vector.
		
	\section{Related work}
		
		The problem of finding shortest path vectors in hexagonal mesh topologies
		has been widely considered and formulations may be found in a verity of
		applications, even including computer games \cite{patel15}. Hexagonal
		toruses by contrast have only received limited attention. In this section I
		briefly summarise the solutions proposed for hexagonal mesh topologies
		before more deeply examining existing solutions for torus topologies.
		
		\subsection{Hexagonal Mesh Networks}
			
			\begin{figure}
				\center
				\buildfig{figures/hex-mesh-topology-coordinates.tex}
				\caption{An example hexagonal mesh network topology.}
				\label{fig:hex-mesh-topology-coordinates}
			\end{figure}
			
			In hexagonal mesh topologies it is conventional to define three `axes' X,
			Y and Z as shown in figure \ref{fig:hex-mesh-topology-coordinates}
			\cite{patel15}. In this example, the three labelled nodes `A', `B' and
			`C' may be given position vectors such as $(1, 1, 0)$, $(3, 2, 0)$ and
			$(0, 0, -7)$ respectively. As in other mesh networks, a vector between
			two nodes is found by subtracting the nodes' vectors. For example, a
			vector from `A' to `B' is $(3, 2, 0) - (1, 1, 0) = (2, 1, 0)$. This
			vector can then be converted into a route in the same way as a mesh
			network by taking any permutation of the three hops  X$^+\,$X$^+\,$Y$^+$.
			
			As explained in detail in appendix \ref{app:minimal-hex-coordinates},
			there are an infinite number of vectors between any two points. For
			example, the vectors $(1, 0, -1)$ and $(3, 2, 1)$ also reach node `B'
			from `A'. However, for a given pair of nodes, there is always a single,
			unique vector whose magnitude is minimal which is given by the function:
			%
			\begin{equation*}
				\operatorname{minimiseVector}(x,y,z)
					= (x,y,z) - \operatorname{median}(x,y,z) \cdot (1,1,1)
			\end{equation*}
			%
			An important side-effect of this function is that a minimised vector will
			always contain at least one zero element meaning that shortest path
			routes will use at most two of the three available dimensions.
		
		\subsection{Hexagonal Torus Networks}
			
			\begin{figure}
				\center
				
				\begin{subfigure}{\linewidth}
					\center
					\buildfig{figures/distance-map-hex-mesh.tex}
					\caption{Hexagonal mesh topology}
					\label{fig:distance-map-hex-mesh}
				\end{subfigure}
				
				\vspace{1em}
				
				\begin{subfigure}{\linewidth}
					\center
					\buildfig{figures/distance-map-hex-torus.tex}
					\caption{Hexagonal torus topology}
					\label{fig:distance-map-hex-torus}
				\end{subfigure}
				
				\caption{Plots showing the magnitude of shortest path vectors in a
				hexagonal torus topology from various locations marked
				{\color{red}$\times$}.  Darker areas are further away. Contour lines show
				equidistant points.}
				
				\label{fig:distance-map-hex}
			\end{figure}
			
			Unfortunately, unlike non-hexagonal torus topologies, the translation
			technique used for non-hexagonal toruses cannot be used. As illustrated
			in figures \ref{fig:distance-map-hex-mesh} and
			\ref{fig:distance-map-hex-torus}, shortest path vectors from the centre
			or any other part of a hexagonal mesh network do not grow in magnitude in
			the same way that those of a hexagonal torus network do.
			
			I am aware of two approaches to computing shortest path vectors in
			hexagonal toruses in the literature which are described below.
			
			\subsubsection{INSEE Method}
			
				The INSEE interconnect simulator has been used in all published research
				into SpiNNaker's hexagonal torus interconnect to date
				\cite{navaridas09,ghasempour15}. Internally INSEE finds shortest path
				vectors by selecting the shortest of a set of twelve candidate vectors
				known to always contain a shortest path vector.
				
				\begin{figure}
					\center
					\begin{subfigure}{0.45\linewidth}
						\center
						\buildfig{figures/insee-vector-candidates-no-wrap.tex}
						\caption{$(\Delta_\textrm{X}, \Delta_\textrm{Y}) = (5,3)$}
						\label{fig:insee-vector-candidates-no-wrap}
					\end{subfigure}
					\begin{subfigure}{0.45\linewidth}
						\center
						\buildfig{figures/insee-vector-candidates-wrap-x.tex}
						\caption{$(\Delta'_\textrm{X}, \Delta_\textrm{Y}) = (-3,3)$}
						\label{fig:insee-vector-candidates-wrap-x}
					\end{subfigure}
					
					\vspace{1em}
					
					\begin{subfigure}{0.45\linewidth}
						\center
						\buildfig{figures/insee-vector-candidates-wrap-y.tex}
						\caption{$(\Delta_\textrm{X}, \Delta'_\textrm{Y}) = (5,-5)$}
						\label{fig:insee-vector-candidates-wrap-y}
					\end{subfigure}
					\begin{subfigure}{0.45\linewidth}
						\center
						\buildfig{figures/insee-vector-candidates-wrap.tex}
						\caption{$(\Delta'_\textrm{X}, \Delta'_\textrm{Y}) = (-3,-5)$}
						\label{fig:insee-vector-candidates-wrap}
					\end{subfigure}
					
					\vspace{1em}
					
					% Key
					\begin{tikzpicture}[thick]
						\coordinate (last);
						
						% #1 colour
						% #2 label
						\newcommand{\colourkeyentry}[2]{
							\node [#1] [right=of last, fill, rectangle, minimum size=1em] (last) {};
							\node [right=0 of last] (last) {#2};
						}
						
						\colourkeyentry{cb3class0}{$(\textrm{X}, \textrm{Y}, 0)$}
						\colourkeyentry{cb3class1}{$(\textrm{X} - \textrm{Y}, 0, - \textrm{Y})$}
						\colourkeyentry{cb3class2}{$(0, \textrm{Y} - \textrm{X}, - \textrm{X})$}
						
					\end{tikzpicture}
					
					\caption{The twelve candidate shortest-path vectors considered by INSEE
					represented as dimension-order routes. $W=H=8$,
					$(\Delta_\textrm{X},\Delta_\textrm{Y}) = (5, 3)$ and
					$(\Delta'_\textrm{X},\Delta'_\textrm{Y}) = (-3, -5)$.}
					\label{fig:insee-vector-candidates}
				\end{figure}
				
				The twelve vectors considered are constructed as follows.  First a
				shortest path vector from the source to target node is constructed as if
				the network was a 2D mesh producing a vector
				$(\Delta_\textrm{X},\Delta_\textrm{Y})$. A second 2D vector,
				$(\Delta'_\textrm{X},\Delta'_\textrm{Y})$, is also defined:
				%
				\begin{align*}
					\Delta'_\textrm{X} &= \Delta_\textrm{X} - \operatorname{sign}(\Delta_\textrm{X})W
					\\
					\Delta'_\textrm{Y} &= \Delta_\textrm{Y} - \operatorname{sign}(\Delta_\textrm{Y})H
				\end{align*}
				%
				Where $W$ and $H$ are the width and height of the network respectively
				(in nodes). This second vector describes a route from the source to
				destination node that, in a torus topology, \emph{always} wraps around
				the peripheries of both the `X' and `Y' dimensions.
				
				Two further 2D vectors, $(\Delta'_\textrm{X},\Delta_\textrm{Y})$ and
				$(\Delta_\textrm{X},\Delta'_\textrm{Y})$ may be defined which wrap around
				the X and Y axes only, respectively.
				
				Each of the four 2D vectors may be converted into a three hexagonal 3D
				vector in which one element of the vector is zero. In total this results
				in twelve different vectors which cover all combinations of wrapping and
				non-wrapping routes and all combinations of axes used. The vector with
				the smallest magnitude must be the shortest path vector. The twelve
				candidate vectors are illustrated in figure
				\ref{fig:insee-vector-candidates} for an example pair of nodes.
				
				This method can find shortest path vectors in hexagonal torus topologies
				of any aspect ratio but, compared with other methods as we'll see later,
				is relatively clumsy and slow to compute.
			
			\subsubsection{XYZ-Protocol}
				
				\begin{figure}
					\center
					\buildfig{figures/xyz-protocol-regions.tex}
					
					\caption{The four regions defined by the XYZ-protocol.}
					\label{fig:xyz-protocol-regions}
				\end{figure}
			
				Hoffmann and D\'es\'erable describe a technique for computing shortest
				path vectors in hexagonal toruses with equal width and height called
				the XYZ-Protocol \cite{hoffmann15,hoffmann11}. First, the source and
				destination nodes are translated such that the source node lies at the
				centre of the topology. The authors observe that from the centre of the
				topology the pattern with which distances grow differs between the four
				quadrants outlined in figure \ref{fig:xyz-protocol-regions}.
				
				If the destination lies in quadrants 1 or 4, a route may be constructed
				as if in a hexagonal mesh topology. Alternatively, if the destination
				lies in regions 2 or 3, the algorithm tests whether taking a mesh-like
				vector within the region or wrapping-around either the X or Y
				dimensions yields the shortest vector.
				
				By comparison with the INSEE method, the number of vectors considered
				is much smaller, just one for destinations in quadrants 1 and 4 and for
				quadrants 2 and 3 no more than three. Unfortunately, though the
				XYZ-protocol can be computed more cheaply than the INSEE method, it
				does not produce valid shortest path vectors for hexagonal torus
				topologies with aspect ratios other than $1:1$.
		
	\section{The Irregular Quadrant (IQ) Method}
		
		In this section I propose a novel technique for finding shortest path
		vectors in hexagonal torus topologies called the Irregular Quadrant (IQ)
		method and compare its performance with existing techniques.
		
		\subsection{Computing shortest path vectors}
		
			Let us consider the problem of finding a shortest path vector from the node
			at (0, 0, 0), at the bottom-left, to another node somewhere else in a
			hexagonal torus topology.
			
			\begin{figure}
				\center
				\buildfig{figures/shortest-path-regions.tex}
				
				\caption{Hexagonal torus topologies of various aspect ratios divided
				into regions in which a particular pair of dimensions is used.}
				\label{fig:shortest-path-regions}
			\end{figure}
			
			Figure \ref{fig:shortest-path-regions} illustrates how hexagonal torus
			topologies of various aspect ratios may be partitioned into four
			\emph{irregular quadrants}. These quadrants are defined according to which
			axes are wrapped around by the shortest path vectors reaching them. The
			Irregular quadrants correspond with nodes reachable by shortest path
			vectors which are:
			%
			\begin{enumerate}
				\item Non-wrapping
				\item Wrap around X only
				\item Wrap around Y only
				\item Wrap around both X and Y
			\end{enumerate}
			%
			Within each irregular quadrant, we observe that shortest path vectors are
			constrained to using only certain dimensions:
			%
			\begin{enumerate}
				\item Only X$^+$, Y$^+$ and Z$^-$.
				\item Only X$^-$ and Y$^+$
				\item Only X$^+$ and Y$^-$
				\item Only X$^-$, Y$^-$ and Z$^+$.
			\end{enumerate}
			%
			Given the topology is of width and height $W$ and $H$ respectively and the
			destination node's 2D mesh coordinates are $(\Delta_\textrm{X},
			\Delta_\textrm{Y})$ we can define the shortest path vector within each
			Irregular quadrant as:
			%
			\begin{enumerate}
				\item $\operatorname{minimiseVector}(\Delta_\textrm{X},\Delta_\textrm{Y},0)$
				\item $\operatorname{minimiseVector}(-(W-\Delta_\textrm{X}),\Delta_\textrm{Y},0)$
				\item $\operatorname{minimiseVector}(\Delta_\textrm{X},-(H-\Delta_\textrm{Y}),0)$
				\item $\operatorname{minimiseVector}(-(W-\Delta_\textrm{X}),-(H-\Delta_\textrm{Y}),0)$
			\end{enumerate}
			%
			Since we know that $0 \le \Delta_\textrm{X} < W$ and $0 \le
			\Delta_\textrm{Y} < H$, we can heavily simplify expressions for the
			magnitude of each of the above vectors. This yields four expressions giving
			the magnitude of a minimal vector which wraps around according to the four
			irregular quadrants:
			%
			\begin{enumerate}
				\item $\operatorname{max}(\Delta_\textrm{X}, \Delta_\textrm{Y})$
				\item $(W - \Delta_\textrm{X}) + \Delta_\textrm{Y}$
				\item $\Delta_\textrm{X} + (H - \Delta_\textrm{Y})$
				\item $\operatorname{max}(W-\Delta_\textrm{X}, H-\Delta_\textrm{Y})$
			\end{enumerate}
			%
			From these expressions we can cheaply determine which combination of axes
			the shortest path vector wraps around, i.e. which irregular quadrant the
			destination is in. With this information, the shortest path can be found
			by minimising the vector associated with that irregular quadrant.
			
			\begin{figure}
				\inputminted{python}{figures/iqmethod.py}
				
				\caption{A Python implementation of the IQ Method.}
				\label{fig:iqmethod.py}
			\end{figure}
			
			Figure \ref{fig:iqmethod.py} shows a simple Python implementation of the IQ
			method.
			
			Compared with the INSEE method, this technique requires fewer cases to be
			considered (four rather than twelve) making it cheaper to compute.
			
			Unlike the four quadrants defined by the XYZ-protocol, the irregular
			quadrants defined by the IQ method correspond exactly to a particular
			shortest path vector. This means that once the irregular quadrant a point
			lies in has been discovered the shortest path vector can be calculated
			directly without considering multiple options. Though the boundaries
			between the four irregular quadrants are more complex than those of the
			XYZ-protocol's four quadrants, it is only marginally more expensive to
			discover which irregular quadrant a point lies in. In addition, the
			irregular quadrants retain their meaning across different aspect ratios
			making the IQ method suitable for any hexagonal torus topology.
		
		\subsection{Computing distances}
		
			The four vector magnitude expressions can also be combined to produce a
			compact and cheaply computed expression of the distance between two
			points in a hexagonal torus topology:
			%
			\begin{align*}
				\operatorname{shortestPathVectorMagnitude}(\Delta_\textrm{X}, \Delta_\textrm{Y}, W, H) =
				\operatorname{min}(&\operatorname{max}(\Delta_\textrm{X}, \Delta_\textrm{Y}),\\
				                   &(W - \Delta_\textrm{X}) + \Delta_\textrm{Y},\\
				                   &\Delta_\textrm{X} + (H - \Delta_\textrm{Y}),\\
				                   &\operatorname{max}(W-\Delta_\textrm{X}, H-\Delta_\textrm{Y}))
			\end{align*}
			%
			This expression was also independently derived from a graph-theoretic
			study of the hexagonal torus topology by Xiao and Parhami\cite{xiao04}.
		
		\subsection{Computational efficiency}
			
			Since computing shortest path vectors forms an integral part of the
			kernel of many routing algorithms, the runtime of the chosen used can be
			an important consideration.
			
			To compare performance, the runtime of a C implementation of each
			technique was measured. The C implementation of INSEE method is taken
			directly from the INSEE source code \cite{navaridas09}. The C
			implementation of the XYZ-Protocol is a straight implementation of the
			published pseudocode \cite{hoffmann15}.
			
			Each function is called approximately 3 billion times, once for every
			pair of source and destination nodes in a $240\times240$ node hexagonal
			torus topology. The total execution time is then divided by the number of
			calls to the shortest path vector function giving an average runtime.
			This experiment was repeated 50 times and the overall average runtime of
			each shortest path vector function was recorded. The experiments were
			conducted on a cluster of idle workstations with 3.10~GHz Intel
			Core-i5-2400 CPUs. The function implementations were compiled with GCC
			5.3.0 with optimisations enabled (\verb|-O2|).
			
			\begin{figure}
				\center
				\buildrplot{figures/shortest-path-vector-runtimes.R}
				
				\caption{Mean runtime of each shortest path vector function. Error bars
				indicate the range of the mean runtimes of the fifty
				3-billion-combination experiments.}
				\label{fig:shortest-path-vector-runtimes}
			\end{figure}
			
			Figure \ref{fig:shortest-path-vector-runtimes} shows runtimes of each
			shortest path vector function. From these results we can see that the
			INSEE method is slower than the other techniques. Though the XYZ-protocol
			and IQ method have similar performance, since the IQ method can be used
			in the general case it is therefore best candidate for use in new
			applications.
	
	\section{Generating all shortest path vectors}
			
			\begin{figure}
				\center
				\buildfig{figures/wrap-alternatives.tex}
				
				\caption{Two distinct shortest path vectors in a hexagonal torus.}
				\label{fig:wrap-alternatives}
			\end{figure}
			
			In odd-sized non-hexagonal and $1:1$ hexagonal torus topologies there is
			exactly one distinct shortest path vector between any two points. In
			even-sized topologies of these types there may be two distinct shortest
			path vectors of equal magnitude between two nodes exactly half the length
			of an axis away as in figure \ref{fig:wrap-alternatives}. The INSEE and
			IQ methods of computing shortest path vectors may generate either vector
			in these circumstances depending on how ties are broken in their
			implementation.
			
			\begin{figure}
				\center
				\buildfig{figures/spiralling.tex}
				
				\caption{Distinct shortest path vectors between two points, all with
				magnitude 11.}
				\label{fig:spiralling}
			\end{figure}
			
			Unlike non-hexagonal topologies, when the aspect ratio of a hexagonal
			topology is not $1:1$, some points may have many distinct (but equal
			magnitude) shortest path vectors.  For example, figure
			\ref{fig:spiralling} illustrates the three distinct shortest path vectors
			between a single pair of nodes. None of the shortest path vector
			functions discussed will generate all possible vectors, potentially
			reducing the choices available to routing algorithms using the functions.
			To address this shortcoming, I propose a formula which, given any
			shortest path vector, may be used to enumerate every equivalent shortest
			path vector.
			
			In a $W \times H$ hexagonal torus topology, the vector $(0, H, 0)$
			straight-forwardly wraps once around the Y axis arriving back where it
			started. The vector $(1,1,1)$ also results in no movement, arriving back
			where it started (see appendix \ref{app:minimal-hex-coordinates}).
			Consequently $(0,H,0) - H(1,1,1) = (-H, 0, -H)$ must also be a vector
			resulting in no movement.  Adding this vector to vectors of the form $(x,
			0, z)$ where $x\ge H$ and $z\le0$ results in a new distinct shortest path
			vectors.
			
			For example the vector $(10, 0, -1)$ (magnitude 11) in figure
			\ref{fig:spiralling} can be added to $(-4, 0, -4)$ yielding $(6, 0, -5)$
			(also magnitude 11) which is still a shortest path vector between the two
			labelled nodes.  Since $(6, 0, -5)$ still meets the criteria defined
			above ($6 \ge H$ and $-5 \le 0$), we can add $(-4, 0, -4)$ again yielding
			another shortest path vector $(2, 0, -9)$.  This new vector no longer
			meets the required criteria (since $2 \ngeq 4$) and so no further
			shortest path vectors can be produced.
			
			In general, a shortest path vector $(x, 0, z)$ may be converted into
			another shortest path vector $(x', 0, y')$ as defined by the following
			formula:
			%
			\begin{equation*}
				(x', 0, y') = (x, 0, z) - \left(\operatorname{trunc}\left(\frac{z}{H}\right) + n\right)(H, 0, H)
			\end{equation*}
			%
			where
			%
			\begin{equation*}
				\left\{
					n \in \mathbb{Z}
				\;\Big|\;
					0 \le n \le
						\left\lfloor
							\frac{\left|x\right| + \left|z\right|}{H}
						\right\rfloor
				\right\}
			\end{equation*}
			%
			and $\operatorname{trunc}(\cdots)$ is the truncation operator which
			rounds towards zero to the nearest integral value.
			
			A complementary formula may be derived based on the related observation
			that the vector $(W, 0, 0)$ results in no movement. Using these two
			expressions, all possible distinct shortest path vectors between two
			points in a hexagonal torus topology may be enumerate.
	
	\section{Conclusions}
		
		The calculation of shortest path vectors in mesh and torus topologies forms
		the heart of many routing algorithms. In this chapter I have introduced a
		new technique for computing shortest path vectors in hexagonal toruses
		which generalises to any hexagonal torus topology while executing more
		quickly than existing approaches. In addition I describe a formula for
		enumerating the many distinct shortest path vectors between pairs of points
		in hexagonal torus topologies. Unlike previous work, this allows routing
		algorithms greater freedom by providing a choice of shortest path vectors
		between some points. These contributions demonstrate that key operations
		such as computing distances and vectors in hexagonal toruses can be
		efficient and exhaustive just as in better understood non-hexagonal torus
		topologies.
